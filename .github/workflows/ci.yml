name: CI Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies (locked)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-locked.txt

      - name: Lint (syntax)
        run: |
          python -m py_compile synthla_edu_v2.py

      - name: Run tests
        run: |
          pytest -q

      - name: Check imports (without data)
        run: |
          python -c "
          import sys
          # Mock to avoid data loading
          class MockSchema: pass
          # Just check syntax and basic structure
          with open('synthla_edu_v2.py', 'r') as f:
              code = f.read()
              assert 'def build_dataset' in code
              assert 'class GaussianCopulaSynth' in code
              assert 'class CTGANSynth' in code
              assert 'class TabDDPMSynth' in code
              print('✓ All main functions and classes present')
          "

      - name: Validate Python version compatibility
        run: |
          python --version
          echo "✓ Python 3.11 verified"
